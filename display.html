<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        body { font-family: 'Cairo', sans-serif; overflow: hidden; background: linear-gradient(135deg,#eff6ff,#e9d5ff); }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification-bar { animation: slideDown 0.5s ease-out; }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .blink { animation: blink 1s ease-in-out infinite; }
        .clinic-card { transition: background-color 0.3s ease, border-color 0.3s ease; }
        .clinic-card.active { border-color: #2563eb; }
        .clinic-card.paused { opacity: 0.5; }
        .news-ticker-container { padding-top: 1.25rem; padding-bottom: 1.25rem; }
        .promo-banner {
            position: fixed; bottom: 30px; right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 10px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 40;
            width: 200px; min-height: 100px;
            transform: translateX(150%); transition: transform 0.6s ease-in-out;
            display: flex; flex-direction: row; align-items: center; justify-content: center; text-align: center;
        }
        .promo-banner.show { transform: translateX(0); }
        .promo-banner.hide { transform: translateX(150%); }
        html, body { height: 100%; }
        .main-content-wrapper { transform-origin: top right; transition: transform 0.3s ease; }
    </style>
</head>
<body class="h-screen flex flex-col">

<!-- Top Bar -->
<div class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white px-6 py-3 flex items-center justify-between shadow-lg">
    <div class="flex items-center gap-4">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
        <h1 id="centerName" class="text-2xl font-bold">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ</h1>
    </div>
    <div class="flex items-center gap-4 text-right">
        <div id="currentTime" class="text-3xl font-bold"></div>
        <div class="text-sm"><div id="currentDate" class="font-semibold"></div></div>
    </div>
    <button onclick="toggleSettingsMenu()" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>
</div>

<!-- Settings Menu -->
<div id="settingsMenu" class="hidden fixed top-16 left-6 bg-white rounded-lg shadow-2xl p-6 z-50 w-80">
    <h3 class="text-xl font-bold text-gray-800 mb-4">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶</h3>
    <div class="space-y-4">
        <div>
            <label class="block text-gray-700 font-bold mb-2">Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø´Ø©:</label>
            <select id="screenSelectMenu" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <option value="1">Ø§Ù„Ø´Ø§Ø´Ø© 1</option><option value="2">Ø§Ù„Ø´Ø§Ø´Ø© 2</option><option value="3">Ø§Ù„Ø´Ø§Ø´Ø© 3</option><option value="4">Ø§Ù„Ø´Ø§Ø´Ø© 4</option>
            </select>
        </div>

        <!-- Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
        <div>
            <label class="block text-gray-700 font-bold mb-2">Ø­Ø¬Ù… Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶:</label>
            <div class="flex gap-2">
                <button onclick="setClinicsWidth('quarter')" class="flex-1 bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700">Â¼ Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
                <button onclick="setClinicsWidth('half')" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700">Â½ ÙˆØ³Ø¹</button>
            </div>
        </div>

        <div>
            <label class="block text-gray-700 font-bold mb-2">Ø§Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±:</label>
            <div class="flex gap-2">
                <button onclick="zoomIn()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">ğŸ”+ ØªÙƒØ¨ÙŠØ±</button>
                <button onclick="zoomOut()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">ğŸ”- ØªØµØºÙŠØ±</button>
            </div>
            <button onclick="resetZoom()" class="w-full mt-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <p class="text-sm text-gray-600 mt-2 text-center">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="zoomLevel">100%</span></p>
        </div>

        <div>
            <label class="block text-gray-700 font-bold mb-2">ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©:</label>
            <button onclick="toggleFullscreen()" id="fullscreenBtnMenu" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">ğŸ“º ØªÙØ¹ÙŠÙ„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
        </div>

        <button onclick="toggleSettingsMenu()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Notification Bar -->
<div id="notificationBar" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="notification-bar bg-gradient-to-r from-green-500 to-emerald-600 text-white px-12 py-8 shadow-2xl rounded-xl max-w-4xl w-full mx-8">
        <div class="flex flex-col items-center gap-6">
            <svg class="w-20 h-20 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
            <div class="text-center"><p id="notificationText" class="text-4xl font-bold mb-3"></p><p id="notificationTime" class="text-2xl font-bold"></p></div>
        </div>
    </div>
</div>

<!-- Promo Banner -->
<div id="promoBanner" class="promo-banner">
    <div class="flex flex-row items-center justify-center h-full">
        <img id="promoDoctorImage" src="" alt="" class="w-24 h-24 rounded-full object-cover border-3 border-white mb-4">
        <div><p id="promoDoctorName" class="text-xl font-bold mb-1"></p><p id="promoSpecialty" class="text-base opacity-90"></p></div>
    </div>
</div>

<!-- Main Content -->
<div class="main-content-wrapper flex-1 flex overflow-hidden">
    <!-- Clinics Column -->
    <div id="clinicsContainer" class="w-1/4 p-4 overflow-hidden flex flex-col"></div>

    <!-- Video Player -->
    <div id="videoContainer" class="flex-1 p-4">
        <div class="bg-black rounded-xl shadow-xl h-full overflow-hidden relative">
            <video id="videoPlayer" class="w-full h-full object-contain" autoplay loop muted playsinline></video>
            <div class="absolute bottom-4 left-4 right-4 flex items-center gap-2 bg-black bg-opacity-50 rounded-lg p-2">
                <button onclick="togglePlayPause()" class="text-white p-2 hover:bg-white hover:bg-opacity-20 rounded">
                    <svg id="playIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                    <svg id="pauseIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm8 0a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2V4z"></path></svg>
                </button>
                <button onclick="toggleMute()" class="text-white p-2 hover:bg-white hover:bg-opacity-20 rounded">
                    <svg id="muteIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg>
                    <svg id="unmuteIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
                <input type="range" id="volumeSlider" min="0" max="100" value="50" class="flex-1 mx-2" onchange="changeVolume(this.value)">
                <span class="text-white text-sm" id="volumeDisplay">50%</span>
            </div>
        </div>
    </div>
</div>

<!-- Bottom News Ticker -->
<div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white overflow-hidden relative news-ticker-container">
    <div id="newsTickerContainer" class="absolute whitespace-nowrap"><span id="newsTicker" class="text-2xl font-bold px-8 inline-block">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ - Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„</span></div>
</div>

<!-- QR Card -->
<div class="bg-white rounded-xl shadow-lg p-6 mt-6 text-center">
    <p class="text-gray-800 font-bold text-lg mb-4">Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±Ùƒ Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯</p>
    <div class="w-40 h-40 mx-auto bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgxrALR9twI4A0S7dnwbI-z9kTGKHiCvYSoATnRHaSKzqUvZaPdraUerTGAC4qrBtIcagjsZgylNhPHcscdmY-lY5HzKx2GT5TqezqH5uZlLdlM0NpEkUlNxmm9VSb7q5iTFoiw-wL5lsEW9-I8oGiPPZGWyPYqp5ElCIP4plZji93qzfl52xM_MPQmCCdq/s320/ALMATAR%20%281%29.png" alt="QR Code" class="w-full h-full object-cover">
    </div>
</div>

<script>
/* ========== Firebase Init ========== */
const firebaseConfig = {
  apiKey: "AIzaSyArFKjBYsFhsPyJPJpjLhH2eSEHlUFEzhI",
  authDomain: "queue-717d5.firebaseapp.com",
  databaseURL: "https://queue-717d5-default-rtdb.firebaseio.com",
  projectId: "queue-717d5",
  storageBucket: "queue-717d5.firebasestorage.app",
  messagingSenderId: "837806460328",
  appId: "1:837806460328:web:f2070b93a2784b1b25619d",
  measurementId: "G-GM30LE46F6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const firestore = firebase.firestore();

/* ========== Globals ========== */
let currentScreen = 1;
let audioPath = 'audio/', videoPath = 'media/', speechRate = 1, alertDuration = 5;
let videos = [], currentVideoIndex = 0;
let newsTickerInterval, promoBannerInterval;
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

/* ========== On Load ========== */
window.onload = () => {
    updateDateTime(); setInterval(updateDateTime, 1000);
    loadSettings(); loadClinics(); listenForCalls(); listenForAlerts(); loadVideos(); startPromoBanners();
    document.getElementById('screenSelectMenu').addEventListener('change', e => { currentScreen = +e.target.value; loadClinics(); });
    updatePlayPauseIcons(); updateMuteIcons();
};

/* ========== Date & Time ========== */
function updateDateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

/* ========== Settings ========== */
function loadSettings() {
    db.ref('settings').on('value', snap => {
        const s = snap.val() || {};
        document.getElementById('centerName').textContent = s.centerName || 'Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ';
        document.getElementById('newsTicker').textContent = s.newsContent || 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ';
        startNewsTicker(s.newsSpeed || 50);
        audioPath = s.audioPath || 'audio/'; videoPath = s.videoPath || 'media/';
        speechRate = s.speechRate || 1; alertDuration = s.alertDuration || 5;
        preloadAudio();
    });
}

/* ========== News Ticker ========== */
function startNewsTicker(pps) {
    if (newsTickerInterval) clearInterval(newsTickerInterval);
    const container = document.getElementById('newsTickerContainer'), ticker = document.getElementById('newsTicker'), parent = container.parentElement;
    let pos = parent.offsetWidth;
    container.style.transform = `translateX(${pos}px) translateY(-50%)`; container.style.top = '50%';
    const int = 20, px = (pps / 1000) * int;
    newsTickerInterval = setInterval(() => {
        pos -= px; if (pos < -ticker.offsetWidth) pos = parent.offsetWidth;
        container.style.transform = `translateX(${pos}px) translateY(-50%)`;
    }, int);
}

/* ========== Promo Banner ========== */
function startPromoBanners() {
    showPromoBanner();
    promoBannerInterval = setInterval(showPromoBanner, 30000);
}
async function showPromoBanner() {
    try {
        const day = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
        const snap = await firestore.collection('doctors').where('workStatus', '==', 'Ù†Ø´Ø·').where('workDays', 'array-contains', day).get();
        const banner = document.getElementById('promoBanner');
        if (snap.empty) { banner.classList.remove('show'); banner.classList.add('hide'); return; }
        const doc = snap.docs[Math.floor(Math.random() * snap.docs.length)].data();
        document.getElementById('promoDoctorImage').src = doc.imageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(doc.name)}&background=667eea&color=fff&size=80`;
        document.getElementById('promoDoctorName').textContent = doc.name;
        document.getElementById('promoSpecialty').textContent = doc.specialty || '';
        banner.classList.remove('hide'); banner.classList.add('show');
        setTimeout(() => { banner.classList.remove('show'); banner.classList.add('hide'); }, 20000);
    } catch (e) { document.getElementById('promoBanner').classList.remove('show'); document.getElementById('promoBanner').classList.add('hide'); }
}

/* ========== Clinics ========== */
function loadClinics() {
    db.ref('clinics').on('value', snap => {
        const clinics = snap.val() || {}, container = document.getElementById('clinicsContainer');
        container.innerHTML = '';
        Object.keys(clinics).forEach(id => {
            const c = clinics[id], screens = Array.isArray(c.screens) ? c.screens : [c.screen];
            if (screens.includes(currentScreen)) container.appendChild(createClinicCard(id, c));
        });
    });
}
function createClinicCard(id, c) {
    const div = document.createElement('div');
    div.id = 'clinic-' + id;
    div.className = `clinic-card bg-white rounded-xl shadow-lg p-4 border-r-4 border-blue-600 ${c.status === 'active' ? '' : 'paused'}`;
    const last = c.lastCall ? new Date(c.lastCall).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '--:--';
    div.innerHTML = `
        <div class="flex items-center justify-between mb-2"><h3 class="text-2xl font-bold text-gray-800">${c.name}</h3><span class="text-5xl font-black text-blue-600">${c.currentNumber || 0}</span></div>
        <div class="flex items-center justify-between text-sm text-gray-600"><div class="flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Ø¢Ø®Ø± Ù†Ø¯Ø§Ø¡: ${last}</span></div><span class="${c.status === 'active' ? 'text-green-600' : 'text-red-600'} font-bold">${c.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…ØªÙˆÙ‚Ù'}</span></div>
    `; return div;
}

/* ========== Calls & Alerts ========== */
function listenForCalls() {
    db.ref('calls').orderByChild('timestamp').limitToLast(1).on('child_added', snap => {
        const call = snap.val(); if (!call || call.timestamp < Date.now() - 5000) return;
        db.ref('clinics/' + call.clinicId).once('value', clSnap => {
            const clinic = clSnap.val(); if (!clinic) return;
            const screens = Array.isArray(clinic.screens) ? clinic.screens : [clinic.screen];
            if (screens.includes(currentScreen)) handleCall(call);
        });
    });
}
function listenForAlerts() {
    db.ref('alerts').orderByChild('timestamp').limitToLast(1).on('child_added', snap => {
        const a = snap.val(); if (a && a.timestamp > Date.now() - 5000) showNotification(a.message, new Date(a.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }));
    });
}
async function handleCall(call) {
    const card = document.getElementById('clinic-' + call.clinicId);
    if (card) { card.classList.add('active', 'blink', 'bg-blue-50'); setTimeout(() => card.classList.remove('blink'), 3000); setTimeout(() => card.classList.remove('active', 'bg-blue-50'), 6000); }
    showNotification(`Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… ${call.number} Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ${call.clinicName}`, new Date(call.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }));
    await playCallAudio(call.number, call.clinicName);
}
function showNotification(text, time) {
    const bar = document.getElementById('notificationBar');
    document.getElementById('notificationText').textContent = text;
    document.getElementById('notificationTime').textContent = time;
    bar.classList.remove('hidden');
    setTimeout(() => bar.classList.add('hidden'), alertDuration * 1000);
}

/* ========== Audio & TTS ========== */
async function playCallAudio(num, clinicName) {
    try {
        await playAudioWithRate(audioPath + 'ding.mp3', 1);
        try { await playAudioWithRate(audioPath + num + '.mp3', speechRate); } catch { speakText(num); }
        const clinicsSnap = await db.ref('clinics').once('value'), clinics = clinicsSnap.val() || {};
        const clinic = Object.values(clinics).find(c => c.name === clinicName);
        if (clinic) { try { await playAudioWithRate(audioPath + 'clinic' + clinic.number + '.mp3', speechRate); } catch { speakText(`Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ${clinicName}`); } } else { speakText(`Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ${clinicName}`); }
    } catch { speakText(`Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… ${num} Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ${clinicName}`); }
}
function speakText(text) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'ar-SA'; u.rate = speechRate; speechSynthesis.speak(u); } }
async function playAudioWithRate(url, rate) {
    const res = await fetch(url); if (!res.ok) throw new Error('nf');
    const buf = await audioContext.decodeAudioData(await res.arrayBuffer());
    const src = audioContext.createBufferSource(); src.buffer = buf; src.playbackRate.value = rate; src.connect(audioContext.destination);
    return new Promise((res, rej) => { src.onended = () => res(); src.start(0); });
}
function preloadAudio() {
    const files = ['ding.mp3']; for (let i = 1; i <= 100; i++) files.push(i + '.mp3'); for (let i = 1; i <= 20; i++) files.push('clinic' + i + '.mp3');
    files.forEach(f => { const a = new Audio(audioPath + f); a.preload = 'auto'; }); /* cache without storing globally */
}

/* ========== Video Player (Playlist) ========== */
function loadVideos() {
    db.ref('settings').once('value', snap => {
        const s = snap.val() || {};
        const useLocal = s.useLocalVideos || false;
        const localPath = s.localVideoPath || '/sdcard/Videos/';
        const remotePath = s.videoPath || 'media/';
        const list = s.videoList || ['video1.mp4', 'video2.mp4', 'video3.mp4'];
        videos = list.map(v => (useLocal ? localPath : remotePath) + v);
        const v = document.getElementById('videoPlayer');
        if (videos.length) {
            currentVideoIndex = 0; v.src = videos[0]; v.volume = 0.5; v.muted = false;
            v.addEventListener('ended', nextVideo); v.addEventListener('error', nextVideo);
            v.play().catch(() => {});
        }
    });
}
function nextVideo() {
    currentVideoIndex = (currentVideoIndex + 1) % videos.length;
    const v = document.getElementById('videoPlayer');
    v.src = videos[currentVideoIndex]; v.play().catch(() => {});
}

/* ========== Video Controls ========== */
function togglePlayPause() { const v = document.getElementById('videoPlayer'); v.paused ? v.play().catch(() => {}) : v.pause(); updatePlayPauseIcons(); }
function updatePlayPauseIcons() { const v = document.getElementById('videoPlayer'); document.getElementById('playIcon').classList.toggle('hidden', !v.paused); document.getElementById('pauseIcon').classList.toggle('hidden', v.paused); }
function toggleMute() { const v = document.getElementById('videoPlayer'); v.muted = !v.muted; updateMuteIcons(); }
function updateMuteIcons() { const v = document.getElementById('videoPlayer'); const mute = v.muted || v.volume === 0; document.getElementById('muteIcon').classList.toggle('hidden', !mute); document.getElementById('unmuteIcon').classList.toggle('hidden', mute); }
function changeVolume(val) { const v = document.getElementById('videoPlayer'); v.volume = val / 100; v.muted = false; document.getElementById('volumeDisplay').textContent = val + '%'; updateMuteIcons(); }

/* ========== Settings Menu ========== */
function toggleSettingsMenu() { document.getElementById('settingsMenu').classList.toggle('hidden'); }

/* ========== Fullscreen ========== */
function toggleFullscreen() {
    const isFs = !!document.fullscreenElement;
    isFs ? document.exitFullscreen() : document.documentElement.requestFullscreen();
    ['fullscreenBtn', 'fullscreenBtnMenu'].forEach(id => {
        const btn = document.getElementById(id); if (!btn) return;
        btn.textContent = isFs ? 'ğŸ“º ØªÙØ¹ÙŠÙ„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©' : 'ğŸ“º Ø¥ÙŠÙ‚Ø§Ù Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©';
    });
}

/* ========== Zoom ========== */
let zoomLevel = 1;
function zoomIn() { zoomLevel = Math.min(2.5, +(zoomLevel + 0.04).toFixed(2)); applyZoom(); }
function zoomOut() { zoomLevel = Math.max(0.5, +(zoomLevel - 0.04).toFixed(2)); applyZoom(); }
function resetZoom() { zoomLevel = 1; applyZoom(); }
function applyZoom() {
    document.querySelector('.main-content-wrapper').style.transform = `scale(${zoomLevel})`;
    document.querySelector('.main-content-wrapper').style.transformOrigin = 'top right';
    document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
}

/* ========== Clinics Width Toggle ========== */
function setClinicsWidth(mode) {
    const clinicsCol = document.getElementById('clinicsContainer');
    const videoCol   = document.getElementById('videoContainer');
    if (mode === 'half') {
        clinicsCol.classList.remove('w-1/4'); clinicsCol.classList.add('w-1/2');
        videoCol.classList.remove('flex-1');  videoCol.classList.add('w-1/2');
    } else { // quarter
        clinicsCol.classList.remove('w-1/2'); clinicsCol.classList.add('w-1/4');
        videoCol.classList.remove('w-1/2');   videoCol.classList.add('flex-1');
    }
}

/* ========== Listeners ========== */
document.getElementById('videoPlayer')?.addEventListener('play', updatePlayPauseIcons);
document.getElementById('videoPlayer')?.addEventListener('pause', updatePlayPauseIcons);
document.getElementById('videoPlayer')?.addEventListener('volumechange', updateMuteIcons);
document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible' && audioContext.state === 'suspended') audioContext.resume().catch(() => {}); });
window.addEventListener('beforeunload', () => { clearInterval(promoBannerInterval); clearInterval(newsTickerInterval); });
</script>
</body>
</html>
