<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>شاشة العرض</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        body { font-family: 'Cairo', sans-serif; overflow: hidden; background: linear-gradient(135deg,#eff6ff,#e9d5ff); }
        .clinic-card { transition: all 0.3s ease; border-right: 5px solid #2563eb; }
        .clinic-card.active { border-color: #f59e0b; transform: scale(1.02); background: #fffbeb; }
        .urgent-call { border-color: #dc2626 !important; background: #fee2e2 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } }
        /* News Ticker */
        .news-container { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to right, #f59e0b, #ea580c); color: white; padding: 10px 0; overflow: hidden; z-index: 50; }
        #newsTicker { white-space: nowrap; position: absolute; font-weight: bold; font-size: 1.5rem; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white px-6 py-4 flex items-center justify-between shadow-lg z-10">
        <div class="flex items-center gap-4">
            <h1 id="centerName" class="text-3xl font-bold">المركز الطبي</h1>
        </div>
        <div class="flex items-center gap-6 text-right">
            <div id="currentTime" class="text-4xl font-bold"></div>
            <div id="currentDate" class="text-lg opacity-80"></div>
        </div>
        <div class="relative group">
            <button class="p-2 bg-white/10 rounded hover:bg-white/20">⚙️</button>
            <div class="hidden group-hover:block absolute left-0 top-10 bg-white text-black p-4 rounded shadow-xl w-48 z-50">
                <label>رقم الشاشة:</label>
                <select id="screenSelect" class="w-full border p-2 rounded mt-1" onchange="changeScreen(this.value)">
                    <option value="1">شاشة 1</option>
                    <option value="2">شاشة 2</option>
                    <option value="3">شاشة 3</option>
                    <option value="4">شاشة 4</option>
                </select>
                <button onclick="document.documentElement.requestFullscreen()" class="w-full bg-blue-600 text-white mt-2 p-2 rounded">ملء الشاشة</button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden pb-16">
        <div class="w-1/4 p-4 flex flex-col bg-white/50 backdrop-blur-sm border-l border-gray-200">
            <div id="clinicsContainer" class="flex-1 space-y-4 overflow-y-auto pr-2"></div>
            <div class="mt-4 bg-white p-4 rounded-xl shadow-lg text-center">
                <p class="font-bold text-gray-700 mb-2">تابع دورك</p>
                <img src="qrchimpX256.png" class="w-32 h-32 mx-auto object-contain">
            </div>
        </div>

        <div class="flex-1 bg-black relative">
            <video id="videoPlayer" class="w-full h-full object-contain" autoplay playsinline></video>
        </div>
    </div>

    <div class="news-container h-16">
        <div id="newsTicker">مرحباً بكم في المركز الطبي</div>
    </div>

    <div id="notificationBar" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-12 text-center transform scale-110 shadow-2xl border-4 border-blue-500">
            <div id="notificationText" class="text-6xl font-black text-blue-900 mb-6 leading-tight"></div>
            <div id="notificationTime" class="text-3xl text-gray-500 font-bold"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyArFKjBYsFhsPyJPJpjLhH2eSEHlUFEzhI",
            authDomain: "queue-717d5.firebaseapp.com",
            databaseURL: "https://queue-717d5-default-rtdb.firebaseio.com",
            projectId: "queue-717d5",
            storageBucket: "queue-717d5.firebasestorage.app",
            messagingSenderId: "837806460328",
            appId: "1:837806460328:web:f2070b93a2784b1b25619d",
            measurementId: "G-GM30LE46F6"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentScreen = 1;
        let videoList = [];
        let currentVideoIndex = 0;
        let newsInterval;
        const audioPath = 'audio/';

        window.onload = function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Listen to settings
            db.ref('settings').on('value', (s) => {
                const set = s.val() || {};
                document.getElementById('centerName').innerText = set.centerName || 'المركز الطبي';
                document.getElementById('newsTicker').innerText = set.newsContent || 'مرحباً بكم';
                startNewsTicker(set.newsSpeed || 50);
                
                // Video Setup
                const vList = set.videoList || ['video1.mp4'];
                const useLocal = set.useLocalVideos || false;
                const path = useLocal ? (set.localVideoPath || '') : (set.videoPath || 'media/');
                
                videoList = (Array.isArray(vList) ? vList : vList).map(v => path + v.trim());
                
                const video = document.getElementById('videoPlayer');
                // Play if not playing
                if(video.paused || !video.src) {
                    playVideoAtIndex(0);
                }
            });

            loadClinics();
            listenForCalls();
            listenForAlerts();
            listenForVideoControls(); // [NEW] Remote control listener
        };

        // --- Video Logic ---
        function playVideoAtIndex(index) {
            if (videoList.length === 0) return;
            currentVideoIndex = index % videoList.length;
            if(currentVideoIndex < 0) currentVideoIndex = videoList.length - 1;
            
            const video = document.getElementById('videoPlayer');
            video.src = videoList[currentVideoIndex];
            video.play().catch(e => console.log('Autoplay blocked:', e));
        }

        // Loop functionality
        document.getElementById('videoPlayer').addEventListener('ended', () => {
            playVideoAtIndex(currentVideoIndex + 1);
        });

        // Remote Control Listener
        function listenForVideoControls() {
            const video = document.getElementById('videoPlayer');
            db.ref('video_controls').limitToLast(1).on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (Date.now() - data.timestamp > 5000) return; // Ignore old commands

                switch(data.action) {
                    case 'play': video.play(); break;
                    case 'pause': video.pause(); break;
                    case 'next': playVideoAtIndex(currentVideoIndex + 1); break;
                    case 'previous': playVideoAtIndex(currentVideoIndex - 1); break;
                    case 'mute': video.muted = !video.muted; break;
                    case 'volume': 
                        video.volume = data.val / 100; 
                        video.muted = false;
                        break;
                }
            });
        }

        // --- Clinics & Calls ---
        function loadClinics() {
            db.ref('clinics').on('value', (s) => {
                const container = document.getElementById('clinicsContainer');
                container.innerHTML = '';
                const clinics = s.val() || {};
                
                Object.keys(clinics).forEach(id => {
                    const c = clinics[id];
                    const screens = Array.isArray(c.screens) ? c.screens : [c.screen];
                    
                    if (screens.includes(parseInt(currentScreen))) {
                        container.innerHTML += `
                            <div id="clinic-${id}" class="clinic-card bg-white rounded-xl p-5 shadow-md flex justify-between items-center">
                                <h2 class="text-2xl font-bold text-gray-800">${c.name}</h2>
                                <span class="text-5xl font-black text-blue-600">${c.currentNumber || 0}</span>
                            </div>
                        `;
                    }
                });
            });
        }

        function listenForCalls() {
            db.ref('calls').limitToLast(1).on('child_added', (s) => {
                const call = s.val();
                if (Date.now() - call.timestamp > 10000) return;

                db.ref('clinics/' + call.clinicId).once('value', (cSnap) => {
                    const c = cSnap.val();
                    const screens = Array.isArray(c.screens) ? c.screens : [c.screen];
                    if (screens.includes(parseInt(currentScreen))) {
                        handleCall(call);
                    }
                });
            });
        }

        function handleCall(call) {
            // Visual
            const card = document.getElementById(`clinic-${call.clinicId}`);
            if(card) {
                if(call.isUrgent) card.classList.add('urgent-call');
                else card.classList.add('active');
                
                setTimeout(() => card.classList.remove('active', 'urgent-call'), 8000);
            }

            // Notification
            const notif = document.getElementById('notificationBar');
            document.getElementById('notificationText').innerText = `العميل رقم ${call.number} - ${call.clinicName}`;
            document.getElementById('notificationTime').innerText = new Date().toLocaleTimeString('ar-EG');
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 5000);

            // Audio Sequence
            playAudioSequence(call);
        }

        async function playAudioSequence(call) {
            try {
                await playSound(audioPath + 'ding.mp3');
                await playSound(audioPath + call.number + '.mp3');
                // Try clinic audio, fallback to TTS
                try {
                    await playSound(audioPath + 'clinic' + call.clinicId + '.mp3');
                } catch {
                    const msg = new SpeechSynthesisUtterance(call.clinicName);
                    msg.lang = 'ar-SA';
                    window.speechSynthesis.speak(msg);
                }
            } catch (e) {
                // Total fallback
                const msg = new SpeechSynthesisUtterance(`عميل رقم ${call.number} إلى ${call.clinicName}`);
                msg.lang = 'ar-SA';
                window.speechSynthesis.speak(msg);
            }
        }

        function playSound(src) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(src);
                audio.onended = resolve;
                audio.onerror = reject;
                audio.play().catch(reject);
            });
        }

        function listenForAlerts() {
            db.ref('alerts').limitToLast(1).on('child_added', (s) => {
                if(Date.now() - s.val().timestamp < 10000) {
                    const notif = document.getElementById('notificationBar');
                    document.getElementById('notificationText').innerText = s.val().message;
                    notif.classList.remove('hidden');
                    setTimeout(() => notif.classList.add('hidden'), 8000);
                    
                    const msg = new SpeechSynthesisUtterance(s.val().message);
                    msg.lang = 'ar-SA';
                    window.speechSynthesis.speak(msg);
                }
            });
        }

        // Utils
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').innerText = now.toLocaleTimeString('ar-EG');
            document.getElementById('currentDate').innerText = now.toLocaleDateString('ar-EG', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        }

        function startNewsTicker(speed) {
            if(newsInterval) clearInterval(newsInterval);
            const container = document.getElementById('newsTicker');
            const parent = container.parentElement;
            let pos = parent.offsetWidth;
            
            newsInterval = setInterval(() => {
                pos -= (speed / 30);
                if(pos < -container.offsetWidth) pos = parent.offsetWidth;
                container.style.left = pos + 'px';
            }, 20);
        }

        function changeScreen(val) {
            currentScreen = parseInt(val);
            loadClinics();
        }
    </script>
</body>
</html>
