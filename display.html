<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>شاشة العرض</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        body { font-family: 'Cairo', sans-serif; overflow: hidden; background: linear-gradient(135deg,#eff6ff,#e9d5ff); }
        .clinic-card { transition: all 0.3s ease; }
        .clinic-card.active { border-color: #2563eb; transform: scale(1.02); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .blink { animation: blink 1s infinite; }
        .urgent-call { border: 3px solid #dc2626 !important; background: #fee2e2 !important; animation: urgent-pulse 1s infinite; }
        @keyframes urgent-pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white px-6 py-3 flex items-center justify-between shadow-lg z-10">
        <div class="flex items-center gap-4">
            <h1 id="centerName" class="text-2xl font-bold">المركز الطبي</h1>
        </div>
        <div class="flex items-center gap-4 text-right">
            <div id="currentTime" class="text-3xl font-bold"></div>
            <div class="text-sm font-semibold" id="currentDate"></div>
        </div>
        <div class="relative">
            <button onclick="document.getElementById('settingsMenu').classList.toggle('hidden')" class="p-2 bg-white/20 rounded">⚙️</button>
            <div id="settingsMenu" class="hidden absolute left-0 top-12 bg-white text-black p-4 rounded shadow-xl w-64 z-50">
                <h3 class="font-bold mb-2">إعدادات الشاشة</h3>
                <label>رقم الشاشة:</label>
                <select id="screenSelect" class="w-full border p-2 rounded mb-2" onchange="changeScreen(this.value)">
                    <option value="1">شاشة 1</option>
                    <option value="2">شاشة 2</option>
                    <option value="3">شاشة 3</option>
                    <option value="4">شاشة 4</option>
                </select>
                <button onclick="document.documentElement.requestFullscreen()" class="w-full bg-blue-600 text-white p-2 rounded">ملء الشاشة</button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden">
        <div class="w-1/4 p-4 flex flex-col bg-gray-50/50 backdrop-blur">
            <div id="clinicsContainer" class="flex-1 space-y-3 overflow-y-auto"></div>
            <div class="bg-white p-3 rounded-xl shadow mt-4 text-center">
                <p class="text-xs font-bold mb-2">تابع دورك عبر الهاتف</p>
                <img src="qrchimpX256.png" class="w-24 h-24 mx-auto object-contain">
            </div>
        </div>

        <div class="flex-1 p-4 relative">
            <div class="bg-black rounded-xl shadow-xl h-full overflow-hidden relative">
                <video id="videoPlayer" class="w-full h-full object-contain" autoplay playsinline></video>
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white overflow-hidden py-2 relative">
        <div id="newsTickerContainer" class="whitespace-nowrap absolute" style="left: 100%;">
            <span id="newsTicker" class="text-2xl font-bold px-4">مرحباً بكم</span>
        </div>
    </div>

    <div id="notificationBar" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-10 text-center animate-bounce">
            <div id="notificationText" class="text-5xl font-bold text-blue-900 mb-4"></div>
            <div id="notificationTime" class="text-2xl text-gray-600"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyArFKjBYsFhsPyJPJpjLhH2eSEHlUFEzhI",
            authDomain: "queue-717d5.firebaseapp.com",
            databaseURL: "https://queue-717d5-default-rtdb.firebaseio.com",
            projectId: "queue-717d5",
            storageBucket: "queue-717d5.firebasestorage.app",
            messagingSenderId: "837806460328",
            appId: "1:837806460328:web:f2070b93a2784b1b25619d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentScreen = 1;
        let videoList = [];
        let currentVideoIndex = 0;
        let newsInterval;

        window.onload = function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Load initial settings
            db.ref('settings').on('value', (s) => {
                const set = s.val() || {};
                document.getElementById('centerName').innerText = set.centerName || 'المركز الطبي';
                document.getElementById('newsTicker').innerText = set.newsContent || 'مرحباً بكم';
                startNewsTicker(set.newsSpeed || 50);
                
                // Video setup
                const vList = set.videoList || ['video1.mp4'];
                const useLocal = set.useLocalVideos || false;
                const path = useLocal ? (set.localVideoPath || '') : (set.videoPath || 'media/');
                
                videoList = (Array.isArray(vList) ? vList : vList).map(v => path + v.trim());
                
                const video = document.getElementById('videoPlayer');
                if (videoList.length > 0 && (!video.src || video.src === '')) {
                    playVideoAtIndex(0);
                }
            });

            loadClinics();
            listenForCalls();
            listenForAlerts();
            listenForVideoControls(); // الاستماع لأوامر الفيديو من الإدارة
        };

        // --- Video Logic ---
        function playVideoAtIndex(index) {
            if (videoList.length === 0) return;
            currentVideoIndex = index % videoList.length;
            if(currentVideoIndex < 0) currentVideoIndex = videoList.length - 1;
            
            const video = document.getElementById('videoPlayer');
            video.src = videoList[currentVideoIndex];
            video.play().catch(e => console.log('Autoplay prevented', e));
        }

        document.getElementById('videoPlayer').addEventListener('ended', () => {
            playVideoAtIndex(currentVideoIndex + 1); // Loop to next
        });

        function listenForVideoControls() {
            const video = document.getElementById('videoPlayer');
            db.ref('video_controls').limitToLast(1).on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (Date.now() - data.timestamp > 5000) return; // Ignore old commands

                switch(data.action) {
                    case 'play': video.play(); break;
                    case 'pause': video.pause(); break;
                    case 'next': playVideoAtIndex(currentVideoIndex + 1); break;
                    case 'previous': playVideoAtIndex(currentVideoIndex - 1); break;
                    case 'mute': video.muted = !video.muted; break;
                    case 'volume': 
                        video.volume = data.val / 100; 
                        video.muted = false;
                        break;
                }
            });
        }

        // --- Clinic & Calls Logic ---
        function loadClinics() {
            db.ref('clinics').on('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                const container = document.getElementById('clinicsContainer');
                container.innerHTML = '';
                
                Object.keys(clinics).forEach(id => {
                    const c = clinics[id];
                    const screens = Array.isArray(c.screens) ? c.screens : [c.screen];
                    
                    if (screens.includes(parseInt(currentScreen))) {
                        container.innerHTML += `
                            <div id="clinic-${id}" class="clinic-card bg-white rounded-lg p-4 shadow border-r-4 border-blue-500">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-xl font-bold text-gray-800">${c.name}</h2>
                                    <span class="text-4xl font-black text-blue-600">${c.currentNumber || 0}</span>
                                </div>
                            </div>
                        `;
                    }
                });
            });
        }

        function listenForCalls() {
            db.ref('calls').limitToLast(1).on('child_added', (snapshot) => {
                const call = snapshot.val();
                if (Date.now() - call.timestamp > 10000) return;

                // Check if clinic is on this screen
                db.ref('clinics/' + call.clinicId).once('value', (s) => {
                    const c = s.val();
                    const screens = Array.isArray(c.screens) ? c.screens : [c.screen];
                    
                    if (screens.includes(parseInt(currentScreen))) {
                        handleCall(call);
                    }
                });
            });
        }

        function handleCall(call) {
            // Visual Animation
            const card = document.getElementById(`clinic-${call.clinicId}`);
            if(card) {
                card.classList.add('active', 'blink', 'bg-yellow-50');
                setTimeout(() => card.classList.remove('active', 'blink', 'bg-yellow-50'), 5000);
            }

            // Notification Overlay
            const notif = document.getElementById('notificationBar');
            document.getElementById('notificationText').innerText = `العميل رقم ${call.number} - ${call.clinicName}`;
            document.getElementById('notificationTime').innerText = new Date().toLocaleTimeString('ar-EG');
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 5000);

            // Audio
            playAudioSequence(call);
        }

        async function playAudioSequence(call) {
            const audioPath = 'audio/'; // Or fetch from settings
            try {
                await playSound(audioPath + 'ding.mp3');
                await playSound(audioPath + call.number + '.mp3'); // e.g., "5.mp3"
                await playSound(audioPath + 'clinic' + call.clinicId + '.mp3'); // This requires clinic file mapping, or use TTS
            } catch (e) {
                // Fallback to TTS
                const msg = new SpeechSynthesisUtterance(`العميل رقم ${call.number}، التوجه إلى ${call.clinicName}`);
                msg.lang = 'ar-SA';
                window.speechSynthesis.speak(msg);
            }
        }

        function playSound(src) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(src);
                audio.onended = resolve;
                audio.onerror = reject;
                audio.play().catch(reject);
            });
        }

        function listenForAlerts() {
            db.ref('alerts').limitToLast(1).on('child_added', (s) => {
                if (Date.now() - s.val().timestamp < 10000) {
                    const notif = document.getElementById('notificationBar');
                    document.getElementById('notificationText').innerText = s.val().message;
                    notif.classList.remove('hidden');
                    setTimeout(() => notif.classList.add('hidden'), 8000);
                    // TTS
                    const msg = new SpeechSynthesisUtterance(s.val().message);
                    msg.lang = 'ar-SA';
                    window.speechSynthesis.speak(msg);
                }
            });
        }

        // --- Utility Functions ---
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').innerText = now.toLocaleTimeString('ar-EG');
            document.getElementById('currentDate').innerText = now.toLocaleDateString('ar-EG', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
        }

        function startNewsTicker(speed) {
            if(newsInterval) clearInterval(newsInterval);
            const container = document.getElementById('newsTickerContainer');
            let pos = window.innerWidth;
            
            newsInterval = setInterval(() => {
                pos -= (speed / 20); // Adjust speed factor
                if (pos < -container.offsetWidth) pos = window.innerWidth;
                container.style.left = pos + 'px';
            }, 50);
        }

        function changeScreen(val) {
            currentScreen = parseInt(val);
            loadClinics(); // Reload to filter clinics
        }
    </script>
</body>
</html>
